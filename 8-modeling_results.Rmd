---
title: "Model Selection Results"
author: "Eduardo Yuki Yada"
geometry: margin=1cm
output: 
  pdf_document:
    template: latex-template.tex
---

```{r, include=FALSE}
knitr::opts_chunk$set(
  warning = F,
  message = F
)
```

```{r warning=F, message=F}
library(tidyverse)
library(kableExtra)

source("aux_functions.R")
```

# Model Selection

```{r echo = F}
path <- "./auxiliar/model_selection/performance"

df <- tibble()

for (file in list.files(path)) {
  df <- df %>% bind_rows(readRDS(file.path(path, file)))
}

df <- df %>%
  mutate(Period = gsub(".*_", "", Target),
         Target = gsub("_.*", "", Target) %>% str_to_title,
         Period = factor(
           Period,
           levels = c(
             '30d',
             '30days',
             '60d',
             '180d',
             '180days',
             '1year',
             '2year',
             '3year'
           ),
           labels = c(
             '30 days',
             '30 days',
             '60 days',
             '180 days',
             '180 days',
             '1 year',
             '2 years',
             '3 years'
           )
         ))

df %>%
  ggplot(aes(
    x = Period,
    y = AUC,
    ymin = `Lower Limit`,
    ymax = `Upper Limit`,
    color = Model
  )) +
  facet_grid(~Target, scales = "free") + 
  geom_point(position = position_dodge(width = 0.9)) +
  geom_errorbar(position = position_dodge(width = 0.9)) +
  theme(legend.position = "bottom")

df %>%
  filter(Target == 'Readmission') %>%
  select(Period, Model, AUC, `Lower Limit`, `Upper Limit`) %>%
  arrange(Period, -AUC) %>%
  niceFormatting(caption = 'Readmission models comparison', label = 1)

df %>%
  filter(Target == 'Death') %>%
  select(Period, Model, AUC, `Lower Limit`, `Upper Limit`) %>%
  arrange(Period, -AUC) %>%
  niceFormatting(caption = 'Death models comparison', label = 2)
```

# Final Model

```{r echo = F}
path <- "./auxiliar/final_model/performance"

df <- tibble()

for (file in list.files(path)) {
  df <- df %>% bind_rows(readRDS(file.path(path, file)))
}

df <- df %>%
  mutate(
    Period = gsub(".*_", "", Target),
    Target = gsub("_.*", "", Target) %>% str_to_title,
    Period = factor(
      Period,
      levels = c(
        '30d',
        '30days',
        '60d',
        '180d',
        '180days',
        '1year',
        '2year',
        '3year'
      ),
      labels = c(
        '30 days',
        '30 days',
        '60 days',
        '180 days',
        '180 days',
        '1 year',
        '2 years',
        '3 years'
      )
    ),
    Model = factor(
      Model,
      levels = c(
        'Full Model',
        'Trimmed Model',
        'Feature Selected Model',
        'Tuned Standard Model'
      )
    )
  ) %>%
  filter(Model != 'Trimmed Model')

df %>%
  ggplot(aes(
    x = Period,
    y = AUC,
    ymin = `Lower Limit`,
    ymax = `Upper Limit`,
    color = Model
  )) +
  facet_grid(~Target, scales = "free") + 
  geom_point(position = position_dodge(width = 0.9)) +
  geom_errorbar(position = position_dodge(width = 0.9)) +
  theme(legend.position = "bottom")

df %>%
  filter(Target == 'Readmission') %>%
  select(Period, Model, Features, AUC, `Lower Limit`, `Upper Limit`) %>%
  arrange(Period, -AUC) %>%
  niceFormatting(caption = 'Readmission models comparison', label = 5)

df %>%
  filter(Target == 'Death') %>%
  select(Period, Model, Features, AUC, `Lower Limit`, `Upper Limit`) %>%
  arrange(Period, -AUC) %>%
  niceFormatting(caption = 'Death models comparison', label = 6)
```

# Selected Features

```{r results = 'asis', echo = F}
library(yaml)
library(gluedown)
path <- "./auxiliar/final_model/selected_features"

all_features <- c()

for (file in list.files(path)) {
  features <- read_yaml(file.path(path, file))
  sprintf('## %s\n', tools::file_path_sans_ext(file)) %>% cat
  md_order(features, seq = TRUE, pad = TRUE) %>% print
  cat('\n')
  
  all_features <- c(all_features, features)
}

cat('# Union\n')
md_order(all_features %>% unique(), seq = TRUE, pad = TRUE) %>% print
```
